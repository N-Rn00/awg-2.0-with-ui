FROM --platform=linux/amd64 ghcr.io/gennadykataev/awg-easy:latest AS wg-easy

FROM --platform=linux/amd64 node:20-alpine

# Install AWG tools and dependencies
RUN apk add --no-cache bash iptables ip6tables curl

# Install AWG binaries from official image
COPY --from=amneziavpn/amneziawg-go:latest /usr/bin/amneziawg-go /usr/bin/amneziawg-go
COPY --from=amneziavpn/amneziawg-go:latest /usr/bin/awg /usr/bin/awg
COPY --from=amneziavpn/amneziawg-go:latest /usr/bin/awg-quick /usr/bin/awg-quick

# Create symlinks for compatibility
RUN ln -sf /usr/bin/awg /usr/bin/wg && \
    ln -sf /usr/bin/awg-quick /usr/bin/wg-quick

# Copy Web UI application
COPY --from=wg-easy /app /app

# Install dependencies
RUN cd /app && npm install --production --no-optional 2>/dev/null || true

# Copy AWG 2.0 config and patches
COPY config.js /app/config.js
COPY wireguard-patch.sh /tmp/patch.sh

# Apply patches for AWG 2.0 support
RUN chmod +x /tmp/patch.sh && \
    WG_CONFIG_NAME=awg0 /tmp/patch.sh && \
    rm /tmp/patch.sh

# Set environment
ENV WG_QUICK_USERSPACE_IMPLEMENTATION=amneziawg-go
ENV WG_SUDO=
ENV NODE_ENV=production

# Expose Web UI port
EXPOSE 51821/tcp

WORKDIR /app

CMD ["node", "server.js"]
